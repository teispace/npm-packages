#!/usr/bin/env sh

echo 'ğŸ—ï¸ğŸ‘· Checking your code before committing...'

# Run lint-staged on staged files (fast)
echo 'ğŸ” Linting and formatting staged files...'

echo 'ğŸ§¹ Running Prettier across repository (auto-formatting)...'
yarn format
if [ $? -ne 0 ]; then
    echo 'âŒ Prettier failed. Aborting commit.'
    exit 1
fi

# Stage any formatting changes so lint-staged sees them
git add -A

echo 'ğŸ” Linting and formatting staged files...'
yarn lint-staged

if [ $? -ne 0 ]; then
    echo 'âŒ Lint-staged failed. Please fix the errors and try again.'
    exit 1
fi

# Type check only staged TypeScript files (fast)
echo 'ğŸ” Type checking staged files...'
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
    yarn type-check
    if [ $? -ne 0 ]; then
        echo 'âŒ Type check failed. Please fix TypeScript errors.'
        exit 1
    fi
    echo 'âœ… Type check passed'
else
    echo 'â­ï¸  No TypeScript files to check'
fi

echo 'âœ… Pre-commit checks passed! ğŸ‰'
